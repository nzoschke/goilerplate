import{S as x,g as L,s as D}from"./BwMqE_kT.js";import"./BFES40_V.js";import{o as I}from"./NJNdSpNe.js";import{p as J,x as g,b as O,a as z}from"./BCx6sPza.js";import{p as T}from"./B-aHjxTS.js";import{A as C,R as E}from"./D_f8O-zr.js";const N={art:"",artist:"",barcode:"",compilation:!1,discs:0,genre:"",src:"",title:"",tracks:[],year:new Date(0)},q={art:"",comment:"",id:"",owner:"",src:"",title:"",tracks:[]},F={album:"",albumArtist:"",artist:"",bpm:0,comment:"",disc:0,genre:"",isrc:"",key:"",length:0,mood:"",src:"",title:"",track:0,type:"",year:new Date(0)},v=e=>({art:e.images.at(0)?.url||"",artist:e.artists[0].name,barcode:e.external_ids.upc,compilation:e.album_type=="compilation",discs:1,genre:e.genres[0]||"",src:e.uri,title:e.name,year:new Date(e.release_date)}),P=e=>{const a=v(e);return a.tracks=[],a},R=e=>{const a=e.name.split(" by ");return{album_group:"",artists:[{external_urls:{spotify:""},href:"",id:"",name:a[1],type:"",uri:""}],album_type:"compilation",available_markets:[],copyrights:[],external_ids:{upc:"",isrc:"",ean:""},external_urls:{spotify:""},genres:[],href:"",id:"",images:e.images,label:"",name:a[0],popularity:0,release_date:e.tracks.items[0].added_at,release_date_precision:"",total_tracks:0,type:"",uri:e.uri}},V=e=>({art:e.images[0].url,id:e.snapshot_id,comment:e.description,owner:e.owner.display_name,src:e.uri,title:e.name,tracks:[]}),A=(e,a)=>({album:e.name,albumArtist:e.artists[0].name,artist:a.artists[0].name,bpm:0,comment:a.preview_url||"",disc:a.disc_number,genre:e.genres?.length>0?e.genres[0]:"",isrc:a.external_ids?.isrc||"",key:"",length:a.duration_ms,mood:"",src:a.uri,track:a.track_number,title:a.name,type:"spotify",year:new Date(e.release_date)}),G=e=>{const a=async()=>x.withAccessToken("",{access_token:await e(),token_type:"",expires_in:3600,refresh_token:""}),i=async n=>{const s=await(await a()).albums.get(n.split(":")[2]);return v(s)},m=async n=>{let r=L(n,N);if(r.src!=""){const o=JSON.stringify(r),u=/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/;return r=JSON.parse(o,(p,l)=>typeof l=="string"&&u.test(l)?new Date(l):l),r}const t=await(await a()).albums.get(n.split(":")[2]);return r=P(t),r.tracks=t.tracks.items.map(o=>A(t,o)),D(n,r),r},S=async n=>{const s=await(await a()).playlists.getPlaylist(n.split(":")[2]),t=R(s),o=P(t);return o.tracks=s.tracks.items.map(u=>A(t,u.track)),o},b=async n=>(await w(n)).filter(s=>s&&s.description.includes("JukeLab compilation")),y=async n=>{const r=await a(),s=n.split(":")[2],t=await r.playlists.getPlaylist(s),o=[];let u=0,p=1;for(;u<p;){const d=await r.playlists.getPlaylistItems(s,void 0,void 0,50,u);p=d.total,u+=d.limit,o.push(...d.items)}t.tracks.items=o;const l=V(t);return l.tracks=t.tracks.items.map(d=>A(d.track.album,d.track)),l},w=async n=>{const r=await a(),s=[];let t=0,o=1;for(;t<o;){const u=await r.playlists.getUsersPlaylists(n.split(":")[2],50,t);o=u.total,t+=u.limit,s.push(...u.items)}return s},c=async(n,r)=>{const t=await(await a()).playlists.getPlaylist(n.split(":")[2]),o=await b(t.owner.uri),u=await y(n),p=[];for(const l of u.tracks){const d=o.find(_=>_.description.includes(l.src.split(":")[2])),k=d?await S(d.uri):await f(l.src);p.push(k),r&&r(k),await new Promise(_=>setTimeout(_,10))}return p},h=async n=>{const s=await(await a()).tracks.get(n.split(":")[2]);return A(s.album,s)},f=async n=>{const s=await(await a()).tracks.get(n.split(":")[2]);return m(s.album.uri)};return{album:i,albumTracks:m,playlist:y,playlists:w,playlistAlbums:c,track:h,trackAlbum:f}};function H(e,a){J(a,!0);let i=T(a,"audio",31,()=>z(C)),m=T(a,"log",3,(r,s)=>{}),S=T(a,"src",3,""),b=!1,y="",w=0,c,h="";const f=r=>{if(!r)return;const{paused:s,position:t,timestamp:o,track_window:{current_track:u,previous_tracks:p}}=r;if(!u)return;const{id:l,duration_ms:d,name:k,artists:_}=u;if(m()(`onState paused=${s} position=${t} duration_ms=${d} id=${l} name=${k} artists=${_[0].name}`),l&&l!=h){m()(`onState start id=${l} name=${k}`),h=l,i(i().ended=!1,!0);return}if(s&&t==0&&p?.findIndex($=>$.id===l)!==-1&&o>w+500){w=o,i(i().ended=!0,!0),m()(`onState ended id=${l} name=${k}`);return}i(i().currentTime=t/1e3,!0),i(i().duration=d/1e3,!0)},n=async(r,s)=>{if(!c||y=="")return;if(r)return c.pause();i(i().ended=!1,!0);const t=await c.getCurrentState();if(s==t?.track_window.current_track.uri)return c.togglePlay();await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${y}`,{body:JSON.stringify({device_id:y,uris:[s]}),headers:{Authorization:`Bearer ${await a.token()}`},method:"PUT"})};g(()=>{!b&&!i().paused&&(c?.activateElement(),b=!0)}),g(()=>{n(i().paused,S())}),g(()=>{c?.setVolume(i().volume)}),g(()=>{i().muted?c?.setVolume(0):c?.setVolume(i().volume)}),g(()=>{i(i().muted=i().seeking,!0),i().seeking&&c?.seek(i().currentTime*1e3)}),I(async()=>{if(!await a.token())return;window.onSpotifyWebPlaybackSDKReady=async()=>{c=new Spotify.Player({getOAuthToken:async t=>{const o=await a.token();m()(`getOAuthToken ${o.slice(0,5)}...`,"warning"),o&&t(o)},name:"JukeLab",volume:1}),c.addListener("player_state_changed",t=>{f(t)}),c.addListener("ready",({device_id:t})=>{i(i().readyState=E.EnoughData,!0),y=t,m()(`ready ${t}`)}),c.addListener("not_ready",({device_id:t})=>{m()(`not_ready ${t}`,"warning")}),c.addListener("initialization_error",({message:t})=>{m()(`initialization_error ${t}`,"error")}),c.addListener("authentication_error",({message:t})=>{m()(`authentication_error ${t}`,"error")}),c.addListener("account_error",({message:t})=>{m()(`account_error ${t}`,"error")}),await c.connect(),setInterval(async()=>{f(await c?.getCurrentState())},1e3)};const s=document.createElement("script");s.src="https://sdk.scdn.co/spotify-player.js",document.head.appendChild(s)}),O()}export{G as A,q as P,F as T,H as a,N as b};
