import{s as b,a as x,g as t,f as c,u as W}from"./BCx6sPza.js";import{h as H}from"./CBiTOIEB.js";import{T as q,b as M,P as Q,A as U}from"./CiR3RtPb.js";import{s as m,r as X,g as J,a as Z,c as tt}from"./BwMqE_kT.js";const rt=n=>n.map(s=>({value:s,sort:Math.random()})).sort((s,e)=>s.sort-e.sort).map(({value:s})=>s),ft=(n,s)=>n.reduce((e,l,i)=>{const p=Math.floor(i/s);return e[p]||(e[p]=[]),e[p].push(l),e},[]),et=n=>{const s=/\s+[([].*(deluxe|remaster|expanded|anniversary).*[)\]]$/i,e=n.match(s);return e&&e[0]?n.replace(s,""):n},st=n=>{if(!n||n.length===0)return[n,!1];const s=/\s-\s[\w\d\s]+$/,e=n[0].match(s);return!e||!e[0]?[n,!1]:[n.map(l=>l.replace(s,"")),!0]},_=(n,s=2)=>n.toString().padStart(s,"0");function N(n){return new Promise((s,e)=>{n.oncomplete=n.onsuccess=()=>s(n.result),n.onabort=n.onerror=()=>e(n.error)})}function nt(n,s){let e;const l=()=>{if(e)return e;const i=indexedDB.open(n);return i.onupgradeneeded=()=>i.result.createObjectStore(s),e=N(i),e.then(p=>{p.onclose=()=>e=void 0},()=>{}),e};return(i,p)=>l().then(E=>p(E.transaction(s,i).objectStore(s)))}let T;function j(){return T||(T=nt("keyval-store","keyval")),T}function at(n,s=j()){return s("readonly",e=>N(e.get(n)))}function ut(n,s,e=j()){return e("readwrite",l=>(l.put(s,n),N(l.transaction)))}const pt={albumNum:0,album:M,trackNum:0,track:q},mt=()=>{const n={playlist:"spotify:playlist:0JOnan9Ym7vJ485NEfdu5E",playlists:[["JukeLab 101","spotify:playlist:0JOnan9Ym7vJ485NEfdu5E"],["Jukelab 102","spotify:playlist:3ENY9f8zKVYOegYWNJYAYV"]]};let s=b(x(M)),e=b(x([])),l=b(x([])),i=b(x(Q)),p=b(x([]));const E=x({max:0,value:0});let h=b(x([])),d=b(x([])),$=b(x(q)),v=b(void 0);const z=W(()=>{const r=t(e).indexOf(t(s)),a=t(s).tracks.indexOf(t($));return a>=0?`${_(r)}${_(a+1)}`:"____"}),D=async(r,a)=>{t(s)?.src==r.album.src&&t($)?.src==r.track.src||t(h).find(u=>u.albumSrc==r.album.src&&u.trackSrc==r.track.src)||(t(h).push({albumSrc:r.album.src,trackSrc:r.track.src}),a&&ut(`${r.album.src}${r.track.src}`,a),m("queue",t(h)))},O=r=>{const a=t(e).findIndex(k=>k.src==r.albumSrc),u=t(e)[a],o=u.tracks.findIndex(k=>k.src==r.trackSrc),S=u.tracks[o];return{albumNum:a,album:u,track:S,trackNum:o}},R=async(r,a)=>{let u=J("playlist",n.playlist),o="";if(!await r())u="spotify:playlist:0JOnan9Ym7vJ485NEfdu5E",t(i).title="JukeLab 101",t(i).src=u,o=await(await fetch(H("/playlist.json"))).text();else{const f=U(r);c(i,await f.playlist(u),!0);const g=`${u}:${t(i).id}`;c(e,J(g,[]),!0),t(e).length==0&&(Z(u),E.max=t(i).tracks.length,await f.playlistAlbums(u,w=>{const y=t(e).push(w);E.value=y,y==1&&(c(s,w,!0),c($,w.tracks[0],!0),a?.(w))}),m(g,t(e))),o=JSON.stringify(t(e))}const k=/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/;c(e,JSON.parse(o,(f,g)=>typeof g=="string"&&k.test(g)?new Date(g):g),!0),t(e).forEach(f=>{f.title=et(f.title);const[g,w]=st(f.tracks.map(y=>y.title));w&&g.forEach((y,K)=>f.tracks[K].title=y),f.tracks.length>1&&f.tracks[0].artist!==f.tracks[1].artist&&f.tracks.forEach(y=>y.title=`${y.title} by ${y.artist}`)}),tt("playlist",u)||(m("history",[]),m("queue",[]),m("shuffle",[])),c(p,J("playlists",n.playlists),!0);const Y=t(p).findIndex(f=>f[1]==u);Y>=0?t(p)[Y][0]=t(i).title:t(p).push([t(i).title,u]),m("playlist",u),m("playlists",t(p)),c(l,J("history",[]),!0),c(h,J("queue",[]),!0),c(d,J("shuffle",[]),!0),t(d).length==0&&P();const I=t(l).length?O(t(l)[0]):O(t(d)[0]);c(s,I.album,!0),a?.(t(s)),c($,I.track,!0)},A=async r=>{if(!r)return;t(l).unshift(r),m("history",t(l)),m("queue",t(h)),m("shuffle",t(d));const a=O(r);return c(s,a.album,!0),c($,a.track,!0),c(v,await at(`${a.album.src}${a.track.src}`),!0),r},B=r=>{X(r),r=="history"?c(l,[],!0):r=="queue"?c(h,[],!0):r=="shuffle"&&P()},G=(r,a,u)=>{let o;if(r=="queue")o=t(h);else if(r=="shuffle")o=t(d);else return;const S=o.indexOf(a);if(S==-1)return;if(u===-1/0){o.splice(S,1),m(r,o);return}const k=S+u;k<0||k>=o.length||(o.splice(S,1),o.splice(k,0,a),m(r,o))},L=async()=>{const r=t(h).length>0?t(h).shift():t(d).shift();return A(r)},V=async()=>A(t(l)[1]),C=async r=>{if(r==1)return await L();if(r==-1)return await V()},P=()=>{const r=t(e).map(a=>a.tracks.map(u=>F(a,u))).flat();c(d,rt(r),!0),m("shuffle",t(d))},F=(r,a)=>({albumSrc:r.src,trackSrc:a.src});return{enqueue:D,find:O,get:R,listClear:B,listMove:G,skip:C,get album(){return t(s)},set album(r){c(s,r,!0)},get albums(){return t(e)},get history(){return t(l)},get playlist(){return t(i)},get playlists(){return t(p)},get playing(){return t(z)},get progress(){return E},get queue(){return t(h)},get shuffle(){return t(d)},get track(){return t($)},set track(r){c($,r,!0)},get nowPlayingImage(){return t(v)||t(s).art}}};export{pt as A,mt as P,ft as c,_ as p,rt as s};
